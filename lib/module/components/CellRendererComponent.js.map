{"version":3,"names":["React","useEffect","useMemo","useRef","findNodeHandle","StyleSheet","Animated","runOnUI","useAnimatedStyle","useSharedValue","useDraggableFlatListContext","isWeb","useCellTranslate","typedMemo","useRefs","useAnimatedValues","CellProvider","useStableCallback","CellRendererComponent","props","item","index","onLayout","children","rest","viewRef","cellDataRef","propsRef","containerRef","horizontalAnim","scrollOffset","activeKey","keyExtractor","horizontal","layoutAnimationDisabled","key","offset","size","heldTanslate","translate","cellOffset","cellSize","cellIndex","isActive","animStyle","value","t","transform","translateX","translateY","updateCellMeasurements","onSuccess","x","y","w","h","current","set","measurements","onFail","_propsRef$current","debug","console","log","containerNode","viewNode","nodeHandle","measureLayout","onCellLayout","e","requestAnimationFrame","baseStyle","elevation","zIndex","flexDirection","itemEnteringAnimation","itemExitingAnimation","itemLayoutAnimation","enableLayoutAnimationExperimental","tag","_layoutDisabled","config","global","LayoutAnimationRepository","configs","stashConfig","stashedConfig","getStashedConfig","removeConfig","registerConfig","createElement","View","_extends","ref","entering","exiting","layout","undefined","style","styles","zeroTranslate","pointerEvents","create","RNDFLLayoutAnimationConfigStash"],"sources":["CellRendererComponent.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useRef } from \"react\";\nimport {\n  findNodeHandle,\n  LayoutChangeEvent,\n  MeasureLayoutOnSuccessCallback,\n  StyleProp,\n  StyleSheet,\n  ViewStyle,\n} from \"react-native\";\nimport Animated, {\n  runOnUI,\n  useAnimatedStyle,\n  useSharedValue,\n} from \"react-native-reanimated\";\nimport { useDraggableFlatListContext } from \"../context/draggableFlatListContext\";\nimport { isWeb } from \"../constants\";\nimport { useCellTranslate } from \"../hooks/useCellTranslate\";\nimport { typedMemo } from \"../utils\";\nimport { useRefs } from \"../context/refContext\";\nimport { useAnimatedValues } from \"../context/animatedValueContext\";\nimport CellProvider from \"../context/cellContext\";\nimport { useStableCallback } from \"../hooks/useStableCallback\";\n\ntype Props<T> = {\n  item: T;\n  index: number;\n  children: React.ReactNode;\n  onLayout?: (e: LayoutChangeEvent) => void;\n  style?: StyleProp<ViewStyle>;\n};\n\nfunction CellRendererComponent<T>(props: Props<T>) {\n  const { item, index, onLayout, children, ...rest } = props;\n\n  const viewRef = useRef<Animated.View>(null);\n  const { cellDataRef, propsRef, containerRef } = useRefs<T>();\n\n  const { horizontalAnim, scrollOffset } = useAnimatedValues();\n  const {\n    activeKey,\n    keyExtractor,\n    horizontal,\n    layoutAnimationDisabled,\n  } = useDraggableFlatListContext<T>();\n\n  const key = keyExtractor(item, index);\n  const offset = useSharedValue(-1);\n  const size = useSharedValue(-1);\n  const heldTanslate = useSharedValue(0);\n\n  const translate = useCellTranslate({\n    cellOffset: offset,\n    cellSize: size,\n    cellIndex: index,\n  });\n\n  const isActive = activeKey === key;\n\n  const animStyle = useAnimatedStyle(() => {\n    // When activeKey becomes null at the end of a drag and the list reorders,\n    // the animated style may apply before the next paint, causing a flicker.\n    // Solution is to hold over the last animated value until the next onLayout.\n    // (Not required in web)\n    if (translate.value && !isWeb) {\n      heldTanslate.value = translate.value;\n    }\n    const t = activeKey ? translate.value : heldTanslate.value;\n    return {\n      transform: [horizontalAnim.value ? { translateX: t } : { translateY: t }],\n    };\n  }, [translate, activeKey]);\n\n  const updateCellMeasurements = useStableCallback(() => {\n    const onSuccess: MeasureLayoutOnSuccessCallback = (x, y, w, h) => {\n      if (isWeb && horizontal) x += scrollOffset.value;\n      const cellOffset = horizontal ? x : y;\n      const cellSize = horizontal ? w : h;\n      cellDataRef.current.set(key, {\n        measurements: { size: cellSize, offset: cellOffset },\n      });\n\n      size.value = cellSize;\n      offset.value = cellOffset;\n    };\n\n    const onFail = () => {\n      if (propsRef.current?.debug) {\n        console.log(`## on measure fail, index: ${index}`);\n      }\n    };\n\n    const containerNode = containerRef.current;\n    const viewNode = viewRef.current;\n    const nodeHandle = containerNode;\n\n    if (viewNode && nodeHandle) {\n      //@ts-ignore\n      viewNode.measureLayout(nodeHandle, onSuccess, onFail);\n    }\n  });\n\n  const onCellLayout = useStableCallback((e?: LayoutChangeEvent) => {\n    heldTanslate.value = 0;\n    updateCellMeasurements();\n    if (onLayout && e) onLayout(e);\n  });\n\n  useEffect(() => {\n    if (isWeb) {\n      // onLayout isn't called on web when the cell index changes, so we manually re-measure\n      requestAnimationFrame(() => {\n        onCellLayout();\n      });\n    }\n  }, [index, onCellLayout]);\n\n  const baseStyle = useMemo(() => {\n    return {\n      elevation: isActive ? 1 : 0,\n      zIndex: isActive ? 999 : 0,\n      flexDirection: horizontal ? (\"row\" as const) : (\"column\" as const),\n    };\n  }, [isActive, horizontal]);\n\n  const {\n    itemEnteringAnimation,\n    itemExitingAnimation,\n    itemLayoutAnimation,\n  } = propsRef.current;\n\n  useEffect(() => {\n    // NOTE: Keep an eye on reanimated LayoutAnimation refactor:\n    // https://github.com/software-mansion/react-native-reanimated/pull/3332/files\n    // We might have to change the way we register/unregister LayouAnimations:\n    // - get native module: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L18\n    // - register layout animation for tag: https://github.com/software-mansion/react-native-reanimated/blob/cf59766460d05eb30357913455318d8a95909468/src/reanimated2/NativeReanimated/NativeReanimated.ts#L99\n    if (!propsRef.current.enableLayoutAnimationExperimental) return;\n    const tag = findNodeHandle(viewRef.current);\n\n    runOnUI((t: number | null, _layoutDisabled) => {\n      \"worklet\";\n      if (!t) return;\n      const config = global.LayoutAnimationRepository.configs[t];\n      if (config) stashConfig(t, config);\n      const stashedConfig = getStashedConfig(t);\n      if (_layoutDisabled) {\n        global.LayoutAnimationRepository.removeConfig(t);\n      } else if (stashedConfig) {\n        global.LayoutAnimationRepository.registerConfig(t, stashedConfig);\n      }\n    })(tag, layoutAnimationDisabled);\n  }, [layoutAnimationDisabled]);\n\n  return (\n    <Animated.View\n      {...rest}\n      ref={viewRef}\n      onLayout={onCellLayout}\n      entering={itemEnteringAnimation}\n      exiting={itemExitingAnimation}\n      layout={\n        propsRef.current.enableLayoutAnimationExperimental\n          ? itemLayoutAnimation\n          : undefined\n      }\n      style={[\n        props.style,\n        baseStyle,\n        activeKey ? animStyle : styles.zeroTranslate,\n      ]}\n      pointerEvents={activeKey ? \"none\" : \"auto\"}\n    >\n      <CellProvider isActive={isActive}>{children}</CellProvider>\n    </Animated.View>\n  );\n}\n\nexport default typedMemo(CellRendererComponent);\n\nconst styles = StyleSheet.create({\n  zeroTranslate: {\n    transform: [{ translateX: 0 }, { translateY: 0 }],\n  },\n});\n\ndeclare global {\n  namespace NodeJS {\n    interface Global {\n      RNDFLLayoutAnimationConfigStash: Record<string, unknown>;\n    }\n  }\n}\n\nrunOnUI(() => {\n  \"worklet\";\n  global.RNDFLLayoutAnimationConfigStash = {};\n})();\n\nfunction stashConfig(tag: number, config: unknown) {\n  \"worklet\";\n  if (!global.RNDFLLayoutAnimationConfigStash)\n    global.RNDFLLayoutAnimationConfigStash = {};\n  global.RNDFLLayoutAnimationConfigStash[tag] = config;\n}\n\nfunction getStashedConfig(tag: number) {\n  \"worklet\";\n  if (!global.RNDFLLayoutAnimationConfigStash) return null;\n  return global.RNDFLLayoutAnimationConfigStash[tag] as Record<string, unknown>;\n}\n"],"mappings":"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","ignoreList":[]}